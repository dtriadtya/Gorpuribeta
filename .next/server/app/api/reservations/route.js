"use strict";(()=>{var a={};a.id=9984,a.ids=[9984],a.modules={53524:a=>{a.exports=require("@prisma/client")},30517:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:a=>{a.exports=require("buffer")},6113:a=>{a.exports=require("crypto")},12781:a=>{a.exports=require("stream")},73837:a=>{a.exports=require("util")},71007:(a,e,r)=>{r.r(e),r.d(e,{headerHooks:()=>m,originalPathname:()=>g,requestAsyncStorage:()=>d,routeModule:()=>u,serverHooks:()=>p,staticGenerationAsyncStorage:()=>o,staticGenerationBailout:()=>v});var t={};r.r(t),r.d(t,{GET:()=>GET,POST:()=>POST});var n=r(10884),s=r(16132),i=r(95798),l=r(15204),_=r(58724);async function GET(a){try{let e=a.headers.get("authorization");if(e){let a=e.replace("Bearer ",""),r=await (0,_.j)(a);r.valid&&r.user&&r.user.id_user}let{searchParams:r}=new URL(a.url),t=r.get("user_id"),n=r.get("field_id"),s=r.get("date"),u={};t&&(u.id_user=parseInt(t)),n&&(u.id_lapangan=parseInt(n)),s&&(u.tanggal_reservasi=new Date(s));let d=await l._.reservation.findMany({where:u,include:{user:{select:{id_user:!0,nama_user:!0,email_user:!0,phone_user:!0}},lapangan:{select:{id_lapangan:!0,nama_lapangan:!0}},validator_dp:{select:{id_user:!0,nama_user:!0,email_user:!0}},validator_pelunasan:{select:{id_user:!0,nama_user:!0,email_user:!0}}},orderBy:[{tanggal_reservasi:"desc"},{jam_mulai_reservasi:"desc"}]}),o=d.map(a=>({id:a.id_reservasi,user_id:a.id_user,field_id:a.id_lapangan,field_name:a.lapangan?.nama_lapangan,reservation_date:a.tanggal_reservasi.toISOString(),start_time:a.jam_mulai_reservasi,end_time:a.jam_selesai_reservasi,total_price:Number(a.total_harga),status:a.status_reservasi,payment_status:a.status_pembayaran,payment_type:a.tipe_pembayaran??null,payment_amount:null!=a.paymentAmount?Number(a.paymentAmount):null,payment_proof:a.bukti_lunas,dp_proof:a.bukti_dp,pelunasan_proof:a.bukti_pelunasan,payment_notes:a.paymentNotes,dp_validated_by:a.validasi_dp_oleh??null,dp_validated_at:a.dpValidatedAt?a.dpValidatedAt.toISOString():null,dp_validated_admin:a.validator_dp?{id:a.validator_dp.id_user,name:a.validator_dp.nama_user,email:a.validator_dp.email_user}:null,pelunasan_validated_by:a.validasi_pelunasan_oleh??null,pelunasan_validated_at:a.pelunasanValidatedAt?a.pelunasanValidatedAt.toISOString():null,pelunasan_validated_admin:a.validator_pelunasan?{id:a.validator_pelunasan.id_user,name:a.validator_pelunasan.nama_user,email:a.validator_pelunasan.email_user}:null,notes:a.notes,created_at:a.reservasi_dibuat_pada.toISOString(),updated_at:a.reservasi_diupdate_pada.toISOString(),dpSenderAccountName:a.nama_rekening_dp,pelunasanSenderAccountName:a.nama_rekening_pelunasan,user:a.user}));return i.Z.json({reservations:o})}catch(a){return console.error("Error fetching reservations:",a),i.Z.json({error:"Internal server error"},{status:500})}}async function POST(a){try{let e=await a.json(),{name:r,email:t,phone:n,field_id:s,reservation_date:_,start_time:u,end_time:d,total_price:o,notes:p,payment_type:m,payment_amount:v}=e;if(!r||!t||!n||!s||!_||!u||!d||!o)return i.Z.json({error:"Missing required fields"},{status:400});let g=await l._.field.findFirst({where:{id_lapangan:parseInt(s),isActive:!0}});if(!g)return i.Z.json({error:"Field not found"},{status:404});let c=await l._.reservation.findFirst({where:{id_lapangan:parseInt(s),tanggal_reservasi:new Date(_),status_reservasi:{in:["PENDING","DP_PAID"]},OR:[{AND:[{jam_mulai_reservasi:{lt:d}},{jam_selesai_reservasi:{gt:u}}]}]}});if(c)return i.Z.json({error:"Time slot is already booked"},{status:409});let y=await l._.user.findUnique({where:{email_user:t}});y||(y=await l._.user.create({data:{nama_user:r,email_user:t,phone_user:n,password:"temp_password",role:"USER"}}));let b="DP"===m?"DP":"FULL",f=Number(o),S=(()=>{if("DP"===b){let a=Number(v);return isNaN(a)||a<=0?.5*f:a}let a=Number(v);return isNaN(a)||a<=0?f:a})(),h=await l._.reservation.create({data:{id_user:y.id_user,id_lapangan:parseInt(s),tanggal_reservasi:new Date(_),jam_mulai_reservasi:u,jam_selesai_reservasi:d,total_harga:f,notes:p||null,tipe_pembayaran:b,paymentAmount:S},include:{user:{select:{id_user:!0,nama_user:!0,email_user:!0,phone_user:!0}},lapangan:{select:{id_lapangan:!0,nama_lapangan:!0}}}}),w={id:h.id_reservasi,user_id:h.id_user,field_id:h.id_lapangan,field_name:h.lapangan?.nama_lapangan,reservation_date:h.tanggal_reservasi.toISOString(),start_time:h.jam_mulai_reservasi,end_time:h.jam_selesai_reservasi,total_price:Number(h.total_harga),status:h.status_reservasi,payment_status:h.status_pembayaran,payment_type:h.tipe_pembayaran??null,payment_amount:null!=h.paymentAmount?Number(h.paymentAmount):null,payment_proof:h.bukti_lunas,dp_proof:h.bukti_dp,pelunasan_proof:h.bukti_pelunasan,payment_notes:h.paymentNotes,dp_validated_by:h.validasi_dp_oleh??null,dp_validated_at:h.dpValidatedAt?h.dpValidatedAt.toISOString():null,dp_validated_admin:h.validator_dp?{id:h.validator_dp.id_user,name:h.validator_dp.nama_user,email:h.validator_dp.email_user}:null,pelunasan_validated_by:h.validasi_pelunasan_oleh??null,pelunasan_validated_at:h.pelunasanValidatedAt?h.pelunasanValidatedAt.toISOString():null,pelunasan_validated_admin:h.validator_pelunasan?{id:h.validator_pelunasan.id_user,name:h.validator_pelunasan.nama_user,email:h.validator_pelunasan.email_user}:null,notes:h.notes,created_at:h.reservasi_dibuat_pada.toISOString(),updated_at:h.reservasi_diupdate_pada.toISOString(),user:h.user};return i.Z.json({message:"Reservation created successfully",reservation:w},{status:201})}catch(a){return console.error("Error creating reservation:",a),i.Z.json({error:"Internal server error"},{status:500})}}let u=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/reservations/route",pathname:"/api/reservations",filename:"route",bundlePath:"app/api/reservations/route"},resolvedPagePath:"C:\\Projects\\backup 07-11-2025 4.11\\gorpuribeta-main\\app\\api\\reservations\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:d,staticGenerationAsyncStorage:o,serverHooks:p,headerHooks:m,staticGenerationBailout:v}=u,g="/api/reservations/route"}};var e=require("../../../webpack-runtime.js");e.C(a);var __webpack_exec__=a=>e(e.s=a),r=e.X(0,[2006,8107,6721,8724],()=>__webpack_exec__(71007));module.exports=r})();