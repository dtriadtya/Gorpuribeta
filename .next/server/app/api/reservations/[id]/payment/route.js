"use strict";(()=>{var a={};a.id=8241,a.ids=[8241],a.modules={53524:a=>{a.exports=require("@prisma/client")},30517:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:a=>{a.exports=require("buffer")},6113:a=>{a.exports=require("crypto")},12781:a=>{a.exports=require("stream")},73837:a=>{a.exports=require("util")},55712:(a,e,t)=>{t.r(e),t.d(e,{headerHooks:()=>m,originalPathname:()=>y,requestAsyncStorage:()=>u,routeModule:()=>_,serverHooks:()=>o,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>v});var n={};t.r(n),t.d(n,{PATCH:()=>PATCH});var l=t(10884),i=t(16132),s=t(95798),r=t(15204),d=t(8192);async function PATCH(a,{params:e}){try{let{id:t}=e,n=(0,d.Ym)(a);if(!n||"ADMIN"!==n.role)return s.Z.json({error:"Unauthorized"},{status:401});let l=await a.json(),{paymentStatus:i,adminNotes:_,action:u}=l,p=await r._.reservation.findUnique({where:{id_reservasi:parseInt(t)}});if(!p)return s.Z.json({error:"Reservation not found"},{status:404});if("REJECT_DP"===u){if("DP"!==p.tipe_pembayaran)return s.Z.json({error:"Penolakan DP hanya berlaku untuk pembayaran DP"},{status:400});let a=!!(p.bukti_dp||p.bukti_lunas);if(!a)return s.Z.json({error:"Tidak ada bukti DP yang dapat ditolak"},{status:400});let e=_?`[Admin Tolak DP]: ${_}`:"[Admin Tolak DP] Bukti DP ditolak. Mohon upload ulang.",l=(p.paymentNotes||"").trim(),i=l?[l,e].join("\n").trim():e,d=await r._.reservation.update({where:{id_reservasi:parseInt(t)},data:{bukti_dp:null,bukti_lunas:null,status_pembayaran:"DP_REJECTED",status_reservasi:"REJECTED",paymentNotes:i,validasi_lunas_oleh:n.userId,paymentValidatedAt:new Date,validasi_dp_oleh:null,dpValidatedAt:null,validasi_pelunasan_oleh:null,pelunasanValidatedAt:null},include:{user:{select:{id_user:!0,nama_user:!0,email_user:!0,phone_user:!0}},lapangan:{select:{id_lapangan:!0,nama_lapangan:!0}},validator_lunas:{select:{id_user:!0,nama_user:!0,email_user:!0}},validator_dp:{select:{id_user:!0,nama_user:!0,email_user:!0}},validator_pelunasan:{select:{id_user:!0,nama_user:!0,email_user:!0}}}}),u={id:d.id_reservasi,user_id:d.id_user,field_id:d.id_lapangan,field_name:d.lapangan?.nama_lapangan,reservation_date:d.tanggal_reservasi.toISOString(),start_time:d.jam_mulai_reservasi,end_time:d.jam_selesai_reservasi,total_price:Number(d.total_harga),status:d.status_reservasi,payment_status:d.status_pembayaran,payment_type:d.tipe_pembayaran??null,payment_amount:null!=d.paymentAmount?Number(d.paymentAmount):null,payment_proof:d.bukti_lunas,dp_proof:d.bukti_dp,pelunasan_proof:d.bukti_pelunasan,payment_notes:d.paymentNotes,notes:d.notes,payment_validated_by:d.validasi_lunas_oleh??null,payment_validated_at:d.paymentValidatedAt?d.paymentValidatedAt.toISOString():null,payment_validated_admin:d.validator_lunas?{id:d.validator_lunas.id_user,name:d.validator_lunas.nama_user,email:d.validator_lunas.email_user}:null,dp_validated_by:d.validasi_dp_oleh??null,dp_validated_at:d.dpValidatedAt?d.dpValidatedAt.toISOString():null,dp_validated_admin:d.validator_dp?{id:d.validator_dp.id_user,name:d.validator_dp.nama_user,email:d.validator_dp.email_user}:null,pelunasan_validated_by:d.validasi_pelunasan_oleh??null,pelunasan_validated_at:d.pelunasanValidatedAt?d.pelunasanValidatedAt.toISOString():null,pelunasan_validated_admin:d.validator_pelunasan?{id:d.validator_pelunasan.id_user,name:d.validator_pelunasan.nama_user,email:d.validator_pelunasan.email_user}:null,created_at:d.reservasi_dibuat_pada.toISOString(),updated_at:d.reservasi_diupdate_pada.toISOString(),user:d.user,field:d.lapangan};return s.Z.json({message:"Bukti DP ditolak. User dapat mengunggah ulang.",reservation:u})}if("REJECT_PELUNASAN"===u){if("DP"!==p.tipe_pembayaran)return s.Z.json({error:"Penolakan pelunasan hanya berlaku untuk pembayaran DP"},{status:400});if(!p.bukti_pelunasan)return s.Z.json({error:"Tidak ada bukti pelunasan yang dapat ditolak"},{status:400});let a=_?`[Admin Tolak Pelunasan]: ${_}`:"[Admin Tolak Pelunasan] Bukti pelunasan ditolak. Mohon upload ulang.",e=(p.paymentNotes||"").trim(),l=e?[e,a].join("\n").trim():a,i=await r._.reservation.update({where:{id_reservasi:parseInt(t)},data:{bukti_pelunasan:null,bukti_lunas:p.bukti_dp||null,status_pembayaran:"PELUNASAN_REJECTED",status_reservasi:"DP_PAID",paymentNotes:l,validasi_lunas_oleh:n.userId,paymentValidatedAt:new Date,validasi_pelunasan_oleh:null,pelunasanValidatedAt:null},include:{user:{select:{id_user:!0,nama_user:!0,email_user:!0,phone_user:!0}},lapangan:{select:{id_lapangan:!0,nama_lapangan:!0}},validator_lunas:{select:{id_user:!0,nama_user:!0,email_user:!0}},validator_dp:{select:{id_user:!0,nama_user:!0,email_user:!0}},validator_pelunasan:{select:{id_user:!0,nama_user:!0,email_user:!0}}}}),d={id:i.id_reservasi,user_id:i.id_user,field_id:i.id_lapangan,field_name:i.lapangan?.nama_lapangan,reservation_date:i.tanggal_reservasi.toISOString(),start_time:i.jam_mulai_reservasi,end_time:i.jam_selesai_reservasi,total_price:Number(i.total_harga),status:i.status_reservasi,payment_status:i.status_pembayaran,payment_type:i.tipe_pembayaran??null,payment_amount:null!=i.paymentAmount?Number(i.paymentAmount):null,payment_proof:i.bukti_lunas,dp_proof:i.bukti_dp,pelunasan_proof:i.bukti_pelunasan,payment_notes:i.paymentNotes,notes:i.notes,payment_validated_by:i.validasi_lunas_oleh??null,payment_validated_at:i.paymentValidatedAt?i.paymentValidatedAt.toISOString():null,payment_validated_admin:i.validator_lunas?{id:i.validator_lunas.id_user,name:i.validator_lunas.nama_user,email:i.validator_lunas.email_user}:null,dp_validated_by:i.validasi_dp_oleh??null,dp_validated_at:i.dpValidatedAt?i.dpValidatedAt.toISOString():null,dp_validated_admin:i.validator_dp?{id:i.validator_dp.id_user,name:i.validator_dp.nama_user,email:i.validator_dp.email_user}:null,pelunasan_validated_by:i.validasi_pelunasan_oleh??null,pelunasan_validated_at:i.pelunasanValidatedAt?i.pelunasanValidatedAt.toISOString():null,pelunasan_validated_admin:i.validator_pelunasan?{id:i.validator_pelunasan.id_user,name:i.validator_pelunasan.nama_user,email:i.validator_pelunasan.email_user}:null,created_at:i.reservasi_dibuat_pada.toISOString(),updated_at:i.reservasi_diupdate_pada.toISOString(),user:i.user,field:i.lapangan};return s.Z.json({message:"Bukti pelunasan ditolak. User dapat mengunggah ulang.",reservation:d})}if("REJECT_FULL"===u){if("FULL"!==p.tipe_pembayaran)return s.Z.json({error:"Penolakan pembayaran penuh hanya berlaku untuk metode pembayaran Lunas"},{status:400});let a=!!p.bukti_lunas;if(!a)return s.Z.json({error:"Tidak ada bukti pembayaran yang dapat ditolak"},{status:400});let e=_?`[Admin Tolak Pembayaran]: ${_}`:"[Admin Tolak Pembayaran] Bukti pembayaran ditolak. Booking dibatalkan, silakan reservasi ulang.",l=(p.paymentNotes||"").trim(),i=l?[l,e].join("\n").trim():e,d=await r._.reservation.update({where:{id_reservasi:parseInt(t)},data:{bukti_lunas:null,status_pembayaran:"DP_REJECTED",status_reservasi:"REJECTED",paymentNotes:i,validasi_lunas_oleh:n.userId,paymentValidatedAt:new Date,validasi_dp_oleh:null,dpValidatedAt:null,validasi_pelunasan_oleh:null,pelunasanValidatedAt:null},include:{user:{select:{id_user:!0,nama_user:!0,email_user:!0,phone_user:!0}},lapangan:{select:{id_lapangan:!0,nama_lapangan:!0}},validator_lunas:{select:{id_user:!0,nama_user:!0,email_user:!0}},validator_dp:{select:{id_user:!0,nama_user:!0,email_user:!0}},validator_pelunasan:{select:{id_user:!0,nama_user:!0,email_user:!0}}}}),u={id:d.id_reservasi,user_id:d.id_user,field_id:d.id_lapangan,field_name:d.lapangan?.nama_lapangan,reservation_date:d.tanggal_reservasi.toISOString(),start_time:d.jam_mulai_reservasi,end_time:d.jam_selesai_reservasi,total_price:Number(d.total_harga),status:d.status_reservasi,payment_status:d.status_pembayaran,payment_type:d.tipe_pembayaran??null,payment_amount:null!=d.paymentAmount?Number(d.paymentAmount):null,payment_proof:d.bukti_lunas,dp_proof:d.bukti_dp,pelunasan_proof:d.bukti_pelunasan,payment_notes:d.paymentNotes,notes:d.notes,payment_validated_by:d.validasi_lunas_oleh??null,payment_validated_at:d.paymentValidatedAt?d.paymentValidatedAt.toISOString():null,payment_validated_admin:d.validator_lunas?{id:d.validator_lunas.id_user,name:d.validator_lunas.nama_user,email:d.validator_lunas.email_user}:null,dp_validated_by:d.validasi_dp_oleh??null,dp_validated_at:d.dpValidatedAt?d.dpValidatedAt.toISOString():null,dp_validated_admin:d.validator_dp?{id:d.validator_dp.id_user,name:d.validator_dp.nama_user,email:d.validator_dp.email_user}:null,pelunasan_validated_by:d.validasi_pelunasan_oleh??null,pelunasan_validated_at:d.pelunasanValidatedAt?d.pelunasanValidatedAt.toISOString():null,pelunasan_validated_admin:d.validator_pelunasan?{id:d.validator_pelunasan.id_user,name:d.validator_pelunasan.nama_user,email:d.validator_pelunasan.email_user}:null,created_at:d.reservasi_dibuat_pada.toISOString(),updated_at:d.reservasi_diupdate_pada.toISOString(),user:d.user,field:d.lapangan};return s.Z.json({message:"Bukti pembayaran ditolak. Booking telah dibatalkan.",reservation:u})}if(!i||!["PENDING","DP_PAID","PAID","REFUNDED"].includes(i))return s.Z.json({error:"Invalid payment status"},{status:400});if("DP_PAID"===i&&"DP"!==p.tipe_pembayaran)return s.Z.json({error:"DP_PAID hanya berlaku untuk pembayaran DP"},{status:400});let o={status_pembayaran:i,paymentNotes:_?`${p.paymentNotes||""}
[Admin]: ${_}`.trim():p.paymentNotes,validasi_lunas_oleh:n.userId,paymentValidatedAt:new Date};"PAID"===i?o.status_reservasi="COMPLETED":"REFUNDED"===i?o.status_reservasi="CANCELLED":"DP_PAID"===i&&(o.status_reservasi="DP_PAID"),"DP_PAID"===i&&(o.validasi_dp_oleh=n.userId,o.dpValidatedAt=new Date,o.validasi_pelunasan_oleh=null,o.pelunasanValidatedAt=null),"PAID"!==i||(o.validasi_pelunasan_oleh=n.userId,o.pelunasanValidatedAt=new Date,"DP"!==p.tipe_pembayaran?(o.validasi_dp_oleh=n.userId,o.dpValidatedAt=new Date):p.validasi_dp_oleh||(o.validasi_dp_oleh=n.userId,o.dpValidatedAt=new Date)),"REFUNDED"===i&&(o.validasi_pelunasan_oleh=null,o.pelunasanValidatedAt=null),"PAID"===i&&"DP"===p.tipe_pembayaran&&(o.paymentAmount=p.total_harga);let m=await r._.reservation.update({where:{id_reservasi:parseInt(t)},data:o,include:{user:{select:{id_user:!0,nama_user:!0,email_user:!0,phone_user:!0}},lapangan:{select:{id_lapangan:!0,nama_lapangan:!0}},validator_lunas:{select:{id_user:!0,nama_user:!0,email_user:!0}},validator_dp:{select:{id_user:!0,nama_user:!0,email_user:!0}},validator_pelunasan:{select:{id_user:!0,nama_user:!0,email_user:!0}}}}),v={id:m.id_reservasi,user_id:m.id_user,field_id:m.id_lapangan,field_name:m.lapangan?.nama_lapangan,reservation_date:m.tanggal_reservasi.toISOString(),start_time:m.jam_mulai_reservasi,end_time:m.jam_selesai_reservasi,total_price:Number(m.total_harga),status:m.status_reservasi,payment_status:m.status_pembayaran,payment_type:m.tipe_pembayaran??null,payment_amount:null!=m.paymentAmount?Number(m.paymentAmount):null,payment_proof:m.bukti_lunas,dp_proof:m.bukti_dp,pelunasan_proof:m.bukti_pelunasan,payment_notes:m.paymentNotes,notes:m.notes,payment_validated_by:m.validasi_lunas_oleh??null,payment_validated_at:m.paymentValidatedAt?m.paymentValidatedAt.toISOString():null,payment_validated_admin:m.validator_lunas?{id:m.validator_lunas.id_user,name:m.validator_lunas.nama_user,email:m.validator_lunas.email_user}:null,dp_validated_by:m.validasi_dp_oleh??null,dp_validated_at:m.dpValidatedAt?m.dpValidatedAt.toISOString():null,dp_validated_admin:m.validator_dp?{id:m.validator_dp.id_user,name:m.validator_dp.nama_user,email:m.validator_dp.email_user}:null,pelunasan_validated_by:m.validasi_pelunasan_oleh??null,pelunasan_validated_at:m.pelunasanValidatedAt?m.pelunasanValidatedAt.toISOString():null,pelunasan_validated_admin:m.validator_pelunasan?{id:m.validator_pelunasan.id_user,name:m.validator_pelunasan.nama_user,email:m.validator_pelunasan.email_user}:null,created_at:m.reservasi_dibuat_pada.toISOString(),updated_at:m.reservasi_diupdate_pada.toISOString(),user:m.user,field:m.lapangan};return s.Z.json({message:"Payment status updated successfully",reservation:v})}catch(a){return console.error("Error updating payment status:",a),s.Z.json({error:"Internal server error"},{status:500})}}let _=new l.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/reservations/[id]/payment/route",pathname:"/api/reservations/[id]/payment",filename:"route",bundlePath:"app/api/reservations/[id]/payment/route"},resolvedPagePath:"C:\\Projects\\backup 07-11-2025 4.11\\gorpuribeta-main\\app\\api\\reservations\\[id]\\payment\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:u,staticGenerationAsyncStorage:p,serverHooks:o,headerHooks:m,staticGenerationBailout:v}=_,y="/api/reservations/[id]/payment/route"}};var e=require("../../../../../webpack-runtime.js");e.C(a);var __webpack_exec__=a=>e(e.s=a),t=e.X(0,[2006,8107,6721,390],()=>__webpack_exec__(55712));module.exports=t})();